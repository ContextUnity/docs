---
title: Multi-Service Architecture
description: Running Brain with multiple client services (Commerce, PinkPony, Router)
---

# Multi-Service Architecture

ContextBrain is designed to serve multiple client services simultaneously. This guide explains how to configure and run Brain in a multi-service environment.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ContextBrain gRPC Server                         │
│                         (Single instance, port 50051)                    │
│                                                                         │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐           │
│  │ BrainService    │ │ CommerceService │ │ NewsService     │           │
│  │ (Knowledge, KG) │ │ (Products)      │ │ (Pink Pony)     │           │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘           │
│                              │                                          │
│                    ┌─────────┴─────────┐                               │
│                    │   PostgreSQL      │                               │
│                    │   (brain schema)  │                               │
│                    └───────────────────┘                               │
└─────────────────────────────────────────────────────────────────────────┘
                          ▲ gRPC (port 50051)
          ┌───────────────┼───────────────┬───────────────┐
          │               │               │               │
    ┌─────┴─────┐   ┌─────┴─────┐   ┌─────┴─────┐   ┌─────┴─────┐
    │ Commerce  │   │ PinkPony  │   │ Router    │   │ Worker    │
    │ (Django)  │   │ (Temporal)│   │ (LangGraph)│  │ (Temporal)│
    └───────────┘   └───────────┘   └───────────┘   └───────────┘
```

## Key Concepts

### Tenant Isolation

Every request to Brain includes a `tenant_id` for data isolation:

```python
# Commerce uses 'traverse' tenant
await client.search(tenant_id="traverse", query="winter jacket")

# PinkPony uses 'pinkpony' tenant
await client.search(tenant_id="pinkpony", query="news about AI")
```

### Connection Pooling

Brain uses async connection pools to handle concurrent requests:

```python
class PostgresStoreBase:
    def __init__(self, dsn: str, pool_min_size: int = 5, pool_max_size: int = 20):
        self._pool = AsyncConnectionPool(
            dsn,
            min_size=pool_min_size,
            max_size=pool_max_size,
            timeout=60.0,
        )
```

### Schema Isolation

Brain supports schema isolation for unified database deployments:

```python
class PostgresStoreBase:
    async def _configure_connection(self, conn):
        # Each connection gets the correct search_path
        await conn.execute(f"SET search_path TO {self._schema}, public")
```

## Deployment Options

### Option A: Separate Databases (Simple)

Each service has its own PostgreSQL database:

```bash
# Brain
BRAIN_DATABASE_URL=postgresql://brain:pass@localhost:5433/brain

# Commerce
DATABASE_URL=postgresql://commerce:pass@localhost:5432/commerce
```

**Pros**: Complete isolation, easy to backup separately
**Cons**: Two PostgreSQL instances, no cross-queries

### Option B: Unified Database with Schema Isolation (Recommended)

Single PostgreSQL with isolated schemas:

```bash
# Brain
BRAIN_DATABASE_URL=postgresql://brain:pass@localhost:5432/contextunity
BRAIN_SCHEMA=brain

# Commerce (Django)
DATABASE_URL=postgresql://commerce:pass@localhost:5432/contextunity
# Django OPTIONS: {'options': '-c search_path=commerce,public'}
```

**Pros**: Single PostgreSQL, shared extensions (pgvector, ltree)
**Cons**: More complex schema management

### Schema Migration Script

```bash
# Create unified database with schemas
./scripts/migrate_to_unified_db.sh --dry-run  # Preview
./scripts/migrate_to_unified_db.sh             # Execute
```

This creates:
- `contextunity` database
- `brain` schema (for Brain tables)
- `commerce` schema (for Django tables)
- `public` schema (shared extensions)

## Running Services

### Development (Multiple Terminals)

```bash
# Terminal 1: Infrastructure
cd projects/traverse && mise run dev

# Terminal 2: Brain gRPC (port 50051)
cd contextbrain && uv run python -m contextbrain.service

# Terminal 3: Commerce Django (port 8000)
cd contextcommerce && uv run python manage.py runserver

# Terminal 4: Commerce Worker
mise run commerce_worker

# Terminal 5: PinkPony (optional)
cd projects/pinkpony && uv run python -m pinkpony
```

### Docker Compose (All-in-One)

```bash
cd projects/traverse
docker-compose up -d
```

Services use Docker internal network:
- `brain:50051` (internal, not exposed to host)
- `django:8000` (exposed)
- `temporal:7233` (internal)

## Client Modes

BrainClient supports two modes:

### gRPC Mode (Default)

```python
from contextcore import BrainClient

client = BrainClient(mode="grpc", host="localhost:50051")
results = await client.search(tenant_id="traverse", query="...")
```

### Local Mode (Development)

```python
# No Brain server needed - direct library calls
client = BrainClient(mode="local")
results = await client.search(tenant_id="traverse", query="...")
```

Set via environment:
```bash
export CONTEXT_BRAIN_MODE=local
```

## Service Configuration

### Brain Service

```bash
# Required
BRAIN_DATABASE_URL=postgresql://brain:pass@localhost:5432/contextunity
BRAIN_PORT=50051
BRAIN_SCHEMA=brain

# Embeddings
EMBEDDER_TYPE=openai
OPENAI_API_KEY=sk-...

# Optional
LOG_LEVEL=INFO
```

### Commerce Service

```bash
# Django
DATABASE_URL=postgresql://commerce:pass@localhost:5432/contextunity

# Brain connection
CONTEXT_BRAIN_URL=localhost:50051
CONTEXT_BRAIN_MODE=grpc

# Temporal
TEMPORAL_URL=localhost:7233

# Feature flags
COMMERCE_BRAIN_SYNC_ENABLED=true
```

### PinkPony / Router

```bash
# Only Brain connection needed
CONTEXT_BRAIN_URL=localhost:50051
```

## Monitoring

### PostgreSQL Connections

```sql
-- Check active connections
SELECT count(*) FROM pg_stat_activity WHERE datname = 'contextunity';

-- Connections by schema
SELECT client_addr, count(*) 
FROM pg_stat_activity 
WHERE datname = 'contextunity' 
GROUP BY client_addr;
```

### Brain Logs

Brain logs all operations with tenant info:

```
INFO brain:search tenant=traverse query="winter jacket" results=5
INFO commerce:upsert_dealer dealer=vysota sku=ABC123
INFO news:publish tenant=pinkpony post_id=123
```

## Troubleshooting

### Connection Refused on 50051

```bash
# Check if Brain is running
lsof -i :50051

# If port is in use by wrong process
sudo fuser -k 50051/tcp
```

### Too Many Connections

```sql
-- Increase PostgreSQL limit
ALTER SYSTEM SET max_connections = 200;
```

Or increase pool size in Brain:
```python
PostgresKnowledgeStore(dsn=..., pool_max_size=50)
```

### Schema Not Found

```sql
-- Check existing schemas
SELECT schema_name FROM information_schema.schemata;

-- Create missing schema
CREATE SCHEMA brain;
GRANT ALL ON SCHEMA brain TO brain;
```

## See Also

- [BrainClient SDK](/reference/brain-client/)
- [Schema Migration](/guides/schema-migration/)
- [Connection Pooling](/guides/connection-pooling/)
